name: MLOps + GitOps Unified Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  mlops-gitops:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout the repository
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dvc[git] mlflow torch fastapi uvicorn scikit-learn pyyaml pandas

      # 4ï¸âƒ£ Configure GitHub auth for DVC
      - name: Authenticate Git for DVC
        run: |
          git config --global user.email "mlops-bot@github.com"
          git config --global user.name "mlops-bot"
          git config --global credential.helper store
          echo "https://${{ secrets.DVC_GITHUB_TOKEN }}@github.com" > ~/.git-credentials

      # 5ï¸âƒ£ Pull DVC data/models from GitHub remote
      - name: Pull data from DVC remote
        run: |
          dvc pull --force

      # 6ï¸âƒ£ Run training pipeline (DVC)
      - name: Run DVC pipeline
        run: |
          dvc repro

      # 7ï¸âƒ£ Compare new vs old metrics
      - name: Compare metrics
        id: metrics
        run: |
          python src/utils/compare_metrics.py metrics/eval.json > result.txt || true
          echo "improved=$(cat result.txt)" >> $GITHUB_OUTPUT

      # 8ï¸âƒ£ Push updated models/metrics back to DVC remote
      - name: Push to DVC remote
        run: |
          dvc push

      # 9ï¸âƒ£ If improved â†’ commit deploy manifest
      - name: Commit and push deployment manifest
        if: steps.metrics.outputs.improved == 'true'
        run: |
          echo "ğŸ” Model improved â€” up
